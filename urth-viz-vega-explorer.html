<!--
# Copyright (c) Jupyter Development Team.
# Distributed under the terms of the Modified BSD License.
-->
<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../urth-core-behaviors/error-display-behavior.html">
<!-- <link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html"> -->
<link rel="import" href="../urth-viz-behaviors/urth-viz-selection-behavior.html">

<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-slider/paper-slider.html">

<link rel="import" href="../urth-core-dataframe/urth-core-dataframe.html">
<link rel="import" href="../urth-viz-table/urth-viz-table.html">
<link rel="import" href="urth-viz-vega.html" is="urth-core-import">

<!--
Represents a widget that lets the user choose between a set of visualizations for a given dataframe.

Example:

    <urth-viz-vega-explorer ref="aDataFrame"></urth-viz-vega-explorer>

@group Urth Viz
@element urth-viz-vega-explorer
-->
<dom-module id="urth-viz-vega-explorer">
    <link rel="import" type="css" href="../fontawesome/css/font-awesome.min.css">
    <template>
        <style>
          .iron-selected { background-color: yellow; }
        </style>
        <iron-selector attr-for-selected="name" selected="{{type}}">
            <span title="Table" name="table" class="fa fa-table fa-2x"></span>
            <span title="Bar Chart" name="bar" class="fa fa-bar-chart fa-2x"></span>
            <span title="Area Chart" name="area" class="fa fa-area-chart fa-2x"></span>
            <span title="Line Chart" name="line" class="fa fa-line-chart fa-2x"></span>
            <span title="Scatter Chart" name="circle" class="fa fa-bullseye fa-2x"></span>
        </iron-selector>
        <template is="dom-if" if="{{ref}}">
            <urth-core-dataframe
                ref$="{{ref}}"
                value="{{df}}"
                limit="{{limit}}"
                row-as-object="true"
                on-rows-changed="_rowsChanged"
                on-columns-changed="_selectDefaults">
            </urth-core-dataframe>
        </template>
        <template is="dom-if" if="{{showAsTable}}">
            <urth-viz-table datarows="{{df.data}}" columns="{{df.columns}}"></urth-viz-table>
        </template>
        <template is="dom-if" if="{{!showAsTable}}">
          <div>
            <paper-dropdown-menu label="x axis" selected-item-label="{{spec.encoding.x.field}}">
                <paper-listbox class="dropdown-content" selected="{{independent}}">
                    <template is="dom-repeat" items="{{df.columns}}">
                        <paper-item>{{item}}</paper-item>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>
            <paper-dropdown-menu label="y axis" selected-item-label="{{spec.encoding.y.field}}">
                <paper-listbox class="dropdown-content" selected="{{dependent}}">
                    <template is="dom-repeat" items="{{df.columns}}">
                        <paper-item>{{item}}</paper-item>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>
            <template is="dom-if" if="{{_hasSize(type)}}" restamp="true">
              <paper-dropdown-menu label="size" selected-item-label="{{spec.encoding.size.field}}">
                <paper-listbox class="dropdown-content" selected="{{size}}">
                    <template is="dom-repeat" items="{{_quantitativeFields(df.columns)}}">
                        <paper-item>{{item}}</paper-item>
                    </template>
                </paper-listbox>
              </paper-dropdown-menu>
            </template>
            <urth-viz-vega
                mode="vega-lite"
                spec="{{spec}}"
                selection-index="{{selectionIndex}}"
                on-selection-info-changed="_selectionInfoChanged">
            </urth-viz-vega>
          </div>
        </template>
        <paper-slider pin value="{{limit}}" min="10" value="20"></paper-slider>
        <content></content>
    </template>
</dom-module>
<script>

    'use strict';

    Polymer({
        is: 'urth-viz-vega-explorer',

        properties: {

            ref: String,

            /**
             * The `urth-viz-chart` chart type to render.
             */
            type: {
                type: String,
                value: 'bar',
                observer: '_typeChanged'
            },

            showAsTable: {
                type: Boolean,
                computed: '_showAsTable(type)'
            },

            limit: {
                type: Number,
                notify: true
            },

            /**
             * Allows user to select multiple chart components (bars in barchart, slices in pie chart, etc).
            multiSelect: {
                type: Boolean,
                value: false,
                reflectToAttribute: true
            },
             */

            spec: {
                type: Object,
                value: function() {
                    return {
                        description: "A simple chart with embedded data.",
                        mark: "bar",
                        data: { values: []},
                        encoding: {
                            x: {},
                            y: {},
                            size: {}
                        }
                    };
                }
            }
        },

        observers: [
            '_specChanged(spec.encoding.*)'
        ],

        behaviors: [
//            Polymer.IronResizableBehavior,
            Urth.DisplayErrorBehavior,
            Urth.VizSelectionBehavior
        ],

        _typeChanged: function(newType) {
            if (newType != 'table') {
                this.set('spec.mark', newType);
            }

            //TODO: need a generic way of associating channels with types
            if (newType != 'circle') {
                this.set('spec.encoding.size', {});
            }
        },

        _selectionIndexChanged: function() {
            var obj = this.selectionAsObject ? this.spec && this.spec.data.values : this.df && this.df.data;
            if (obj) {
                this._setSelection(obj[this.selectionIndex]); //TODO: multi 
            }
        },

        _specChanged: function(changeRecord) {
            var channelMatch = changeRecord.path.match(/^spec.encoding.([^.]+).field$/)
            if (channelMatch) {
                var type = this._computeType(changeRecord.value),
                    channel = this.spec.encoding[channelMatch[1]];
                channel.type = type;
                if (type === 'temporal') {
                    channel.timeUnit = this._computeUnit(channel.field, false);
                    channel.axis = { shortTimeLabels: true};
                } else {
                    delete channel.timeUnit;
                    if (this.spec.axis) delete this.spec.axis.shortTimeLabels;
                }
            }
        },

        _computeUnit: function(field, periodic) {
            var dates = this.spec.data.values.map(function(row) { return row[field]; });
            var diff = (new Date(Math.max.apply(null, dates)) - new Date(Math.min.apply(null, dates))) / 1000;
            var unit = 'year';

            if (diff < 60 * 60 * 24) unit = periodic ? 'hours' : 'yearmonthdatehoursminutes';
            else if (diff < 60 * 60 * 24 * 30) unit = periodic ? 'day' : 'yearmonthdatehours';
            else if (diff < 60 * 60 * 24 * 30 * 12) unit = periodic ? 'month' : 'yearmonthdate';

            return unit;
        },

        _computeType: function(column) {
            var type = 'nominal',
                row = this.spec.data.values[0],
                data = row[column];

            if (data instanceof Date) {
                type = 'temporal';
            } else if (typeof data == 'number') {
                type = 'quantitative';
            }

            return type;
        },

        _showAsTable: function(type) {
            return type == 'table';
        },

        _hasSize: function(type) {
            return type == 'circle';
        },

        _quantitativeFields: function(columns) {
            return columns.filter(function(column) { return this._computeType(column) === 'quantitative'; }, this);
        },

        _selectDefaults: function(event) {
            if (this._hasDefaults || !this.spec.data.values.length) {
                 return;
            }

            this._hasDefaults = true;

            var df = event.target,
                types = df.columns.map(function(field) { return this._computeType(field); }, this);

            var independent = types.indexOf('temporal');
            if (independent == -1) independent = types.indexOf('quantitative');
            if (independent == -1) independent = 0;
            types[independent] = null;
            this.independent = independent;

            var dependent = types.indexOf('quantitative');
            if (dependent == -1) dependent = 0;
            if (dependent == independent) dependent++;
            types[dependent] = null;
            this.dependent = dependent;
        },

        _rowsChanged: function(event) {
            var values = event.detail.value;

            // tag each element with an index so we can map back to the row from the chart
            values.forEach(function(value, i) {
                value._index = i;
            });

            this.set('spec.data', { values: values });

            if (event.target.columns) {
                this._selectDefaults(event);
            }
        },

        _selectionInfoChanged: function(event) {
            this._setSelectionInfo(event.detail.value);
        },

        ready: function() {
            // If no dataframe instance is specified with `ref`, look instead for a child dataframe
            // and  bind that value to df whenever it changes,
            if (!this.ref) {
                var dataframe = this.querySelector('urth-core-dataframe');

                // manually bind values to 'df' property if using child
                if (dataframe) {
                    this.df = dataframe.value;
                    dataframe.rowAsObject = true;
                    dataframe.limit = this.limit;
                    this.addEventListener('limit-changed', function(event) {
                        dataframe.limit = event.detail.value;
                    }.bind(this));
                    dataframe.addEventListener('value-changed', function(event) {
                        this.df = event.detail.value;
                    }.bind(this));
                    dataframe.addEventListener('columns-changed', this._selectDefaults.bind(this));
                    dataframe.addEventListener('rows-changed', this._rowsChanged.bind(this));
                }
            }
        }
    });

 </script>
